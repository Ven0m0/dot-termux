#!/data/data/com.termux/files/usr/bin/bash
# termux-change-repo: Optimized mirror selector
set -Eeuo pipefail

# -- Config --
readonly MIRROR_BASE="/data/data/com.termux/files/usr/etc/termux/mirrors"
readonly LINK_TARGET="/data/data/com.termux/files/usr/etc/termux/chosen_mirrors"
readonly TMP_DIR="/data/data/com.termux/files/usr/tmp"

# -- Setup & Cleanup --
mkdir -p "$TMP_DIR"
TEMPFILE=$(mktemp "$TMP_DIR/mirror.XXXXXX")
trap 'rm -f "$TEMPFILE"' EXIT INT TERM

# -- Helpers --
die() { echo "[!] $*" >&2; exit 1; }
has() { command -v "$1" &>/dev/null; }

unlink_and_link() {
  local target="$1"
  [[ -L "$LINK_TARGET" ]] && unlink "$LINK_TARGET"
  ln -s "$target" "$LINK_TARGET"
  echo "[*] Selected: ${target##*/}"
}

get_mirror_desc() {
  # Efficiently read line 2
  sed -n '2{s/^# //;p;q}' "$1"
}

# -- Logic --
select_group() {
  # Map labels to directory names
  declare -A groups=(
    ["All mirrors"]="all"
    ["Mirrors in Asia"]="asia"
    ["Mirrors in Chinese Mainland"]="chinese_mainland"
    ["Mirrors in Europe"]="europe"
    ["Mirrors in North America"]="north_america"
    ["Mirrors in Oceania"]="oceania"
    ["Mirrors in Russia"]="russia"
  )

  local options=()
  for k in "${!groups[@]}"; do
    # Default "All mirrors" to on, others off
    [[ $k == "All mirrors" ]] && state="on" || state="off"
    options+=("$k" "Select group" "$state")
  done

  dialog --title "Mirror Groups" --clear --radiolist \
    "Select region (Space to select, Enter to confirm):" \
    0 0 0 "${options[@]}" 2> "$TEMPFILE" || return

  local choice
  choice=$(<"$TEMPFILE")
  [[ -z $choice ]] && return

  local dir="${groups[$choice]}"
  [[ -n $dir ]] && unlink_and_link "$MIRROR_BASE/$dir"
}

select_mirror() {
  local options=()
  # Use fd if available for speed, else find
  local cmd=(find "$MIRROR_BASE" -mindepth 2 -maxdepth 2 -type f ! -name "*.dpkg*")
  has fd && cmd=(fd -t f -d 2 . "$MIRROR_BASE")

  while IFS= read -r m; do
    local name="${m##*/}"
    [[ $name == "default" || $name == "packages.termux.dev" ]] && continue
    options+=("$name" "$(get_mirror_desc "$m")" "off")
  done < <("${cmd[@]}")

  # Add defaults at top
  options=("default" "Official Default" "on" "${options[@]}")

  dialog --title "Single Mirror" --clear --radiolist \
    "Select mirror (Space to select, Enter to confirm):" \
    0 0 0 "${options[@]}" 2> "$TEMPFILE" || return

  local choice
  choice=$(<"$TEMPFILE")
  [[ -z $choice ]] && return

  # Find the full path for the selected mirror
  local path
  path=$(find "$MIRROR_BASE" -name "$choice" -print -quit)
  [[ -n $path ]] && unlink_and_link "$path"
}

# -- Main --
main() {
  has apt || die "apt not found."
  [[ ${TERMUX_APP_PACKAGE_MANAGER:-} == "pacman" ]] && die "Use pacman config for mirrors."

  # Menu
  dialog --title "termux-change-repo" --clear --radiolist \
    "Mode Selection:" 0 0 0 \
    "Mirror group" "Rotate (Recommended)" "on" \
    "Single mirror" "Pick specific URL" "off" 2> "$TEMPFILE" || exit

  case $(<"$TEMPFILE") in
    "Mirror group") select_group ;;
    "Single mirror") select_mirror ;;
  esac

  # Update
  echo "[*] Running update..."
  apt update
}

main "$@"

#!/usr/bin/env bash
# Yadm bootstrap script for Termux dotfiles setup
# This script runs automatically after 'yadm clone --bootstrap'
set -eo pipefail

# ============================================================================
# HELPERS
# ============================================================================
has() { command -v "$1" &>/dev/null; }
info() { printf '\033[32m[INFO]\033[0m %s\n' "$*"; }
warn() { printf '\033[33m[WARN]\033[0m %s\n' "$*"; }
err() { printf '\033[31m[ERROR]\033[0m %s\n' "$*" >&2; }
step() { printf '\n\033[1;34m==> %s\033[0m\n' "$*"; }

# ============================================================================
# ENVIRONMENT SETUP
# ============================================================================
export LC_ALL=C LANG=C
HOME="${HOME:-/data/data/com.termux/files/home}"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"

# Ensure directories exist
mkdir -p "$HOME/.ssh" "$HOME/bin" "$HOME/.termux"
mkdir -p "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_CACHE_HOME"
chmod 700 "$HOME/.ssh"

# ============================================================================
# SYMLINK BIN SCRIPTS
# ============================================================================
step "Setting up bin scripts"
if [[ -d $HOME/bin ]]; then
  # Find all executable files in $HOME/bin and ensure they're executable
  while IFS= read -r -d '' script; do
    if [[ -f $script ]]; then
      chmod +x "$script" 2>/dev/null || warn "Failed to make executable: ${script##*/}"
      info "Made executable: ${script##*/}"
    fi
  done < <(find "$HOME/bin" -type f -print0 2>/dev/null || true)
else
  warn "~/bin directory not found"
fi

# ============================================================================
# SSH KEY SETUP
# ============================================================================
step "Setting up SSH key"
if [[ ! -f $HOME/.ssh/id_rsa ]]; then
  if has ssh-keygen; then
    ssh-keygen -t rsa -b 4096 -f "$HOME/.ssh/id_rsa" -N "" &>/dev/null && info "Generated SSH key: $HOME/.ssh/id_rsa" || warn "Failed to generate SSH key"
  else
    warn "ssh-keygen not found, skipping SSH key generation"
  fi
else
  info "SSH key already exists"
fi

# ============================================================================
# ZSH SETUP
# ============================================================================
step "Setting up Zsh"
if has zsh; then
  # Set Zsh as default shell if not already
  if [[ ${SHELL##*/} != zsh ]]; then
    if has chsh; then
      chsh -s zsh 2>/dev/null || warn "Failed to set Zsh as default shell (may require manual setup)"
    else
      warn "chsh not found, cannot set Zsh as default shell"
    fi
  else
    info "Zsh is already the default shell"
  fi

  # Compile Zsh files for faster loading
  if [[ -f $HOME/.zshrc ]]; then
    zsh -c 'autoload -Uz zrecompile; for f in ~/.zshrc ~/.zshenv ~/.p10k.zsh; do [[ -f $f ]] && zrecompile -pq "$f"; done' &>/dev/null && info "Compiled Zsh configuration files" || warn "Failed to compile Zsh files"
  else
    warn "~/.zshrc not found, skipping Zsh compilation"
  fi
else
  warn "Zsh not found, skipping Zsh setup"
fi

# ============================================================================
# SHELDON PLUGIN MANAGER
# ============================================================================
step "Setting up Sheldon"
if has sheldon; then
  if [[ -f $HOME/.config/sheldon/plugins.toml ]] || [[ -f $HOME/.sheldon/plugins.toml ]]; then
    sheldon lock &>/dev/null && info "Sheldon plugins locked" || warn "Failed to lock Sheldon plugins (may need to run 'sheldon lock' manually)"
  else
    warn "Sheldon config not found, skipping plugin lock"
  fi
else
  warn "Sheldon not found, skipping plugin setup"
fi

# ============================================================================
# TERMUX SPECIFIC SETUP
# ============================================================================
if [[ -n ${TERMUX_VERSION:-} ]] || [[ -d /data/data/com.termux ]]; then
  step "Termux-specific setup"

  # Reload Termux settings if font was installed
  if has termux-reload-settings && [[ -f $HOME/.termux/font.ttf ]]; then
    termux-reload-settings
    info "Reloaded Termux settings"
  fi

  # Setup storage access
  if has termux-setup-storage && [[ ! -d $HOME/storage ]]; then
    warn "Run 'termux-setup-storage' manually to grant storage access"
  fi
fi

# ============================================================================
# FINALIZE
# ============================================================================
step "Bootstrap complete"
info "Dotfiles successfully installed!"
info "Please restart your shell or run: exec \$SHELL"

# Display welcome message
if [[ -f $HOME/.welcome.msg ]]; then
  cat "$HOME/.welcome.msg"
fi
